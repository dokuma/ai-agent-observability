apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "ai-agent-monitoring.configmapName" . }}
  labels:
    {{- include "ai-agent-monitoring.labels" . | nindent 4 }}
data:
  # LLM
  LLM_ENDPOINT: {{ .Values.externalServices.llm.endpoint | quote }}
  LLM_MODEL: {{ .Values.externalServices.llm.model | quote }}
  LLM_VERIFY_SSL: {{ .Values.externalServices.llm.verifySsl | quote }}
  LLM_MAX_RETRIES: {{ .Values.externalServices.llm.maxRetries | quote }}
  # Monitoring Stack
  PROMETHEUS_URL: {{ .Values.externalServices.prometheus.url | quote }}
  LOKI_URL: {{ .Values.externalServices.loki.url | quote }}
  GRAFANA_URL: {{ .Values.externalServices.grafana.url | quote }}
  # MCP Server URLs（Chart 内 Service DNS から自動構築、NO_PROXY=.svc に対応）
  MCP_PROMETHEUS_URL: {{ printf "http://%s-prometheus-mcp.%s.svc:%d" (include "ai-agent-monitoring.fullname" .) .Release.Namespace (.Values.prometheusMcp.service.port | int) | quote }}
  MCP_LOKI_URL: {{ printf "http://%s-loki-mcp.%s.svc:%d" (include "ai-agent-monitoring.fullname" .) .Release.Namespace (.Values.lokiMcp.service.port | int) | quote }}
  MCP_GRAFANA_URL: {{ printf "http://%s-grafana-mcp.%s.svc:%d" .Release.Name .Release.Namespace (index .Values "grafana-mcp" "service" "port" | int) | quote }}
  # Agent
  MAX_ITERATIONS: {{ .Values.config.maxIterations | quote }}
  INVESTIGATION_TIMEOUT_SECONDS: {{ .Values.config.investigationTimeoutSeconds | quote }}
  CORS_ALLOWED_ORIGINS: {{ .Values.config.corsAllowedOrigins | quote }}
  # MCP Transport
  MCP_TRANSPORT: {{ .Values.config.mcpTransport | quote }}
  MCP_GRAFANA_TRANSPORT: {{ .Values.config.mcpGrafanaTransport | quote }}
  MCP_PROMETHEUS_TRANSPORT: {{ .Values.config.mcpPrometheusTransport | quote }}
  MCP_LOKI_TRANSPORT: {{ .Values.config.mcpLokiTransport | quote }}
  # Debug / Logging
  LOG_LEVEL: {{ .Values.config.logLevel | quote }}
  OPENAI_LOG: {{ .Values.config.openaiLog | quote }}
  # MCP TLS
  MCP_USE_TLS: {{ .Values.config.mcpUseTls | quote }}
  MCP_VERIFY_SSL: {{ .Values.config.mcpVerifySsl | quote }}
  MCP_CA_BUNDLE: {{ .Values.config.mcpCaBundle | quote }}
  # Langfuse
  LANGFUSE_ENABLED: {{ .Values.externalServices.langfuse.enabled | quote }}
  # Langfuse SDK は LANGFUSE_TRACING_ENABLED で @observe デコレータを制御
  LANGFUSE_TRACING_ENABLED: {{ .Values.externalServices.langfuse.enabled | quote }}
  LANGFUSE_BASE_URL: {{ .Values.externalServices.langfuse.baseUrl | quote }}
